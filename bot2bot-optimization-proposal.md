# XiaoBa Bot2Bot 群聊协作机制优化方案

**整理人**: ErGoz  
**日期**: 2026-02-19  
**参与讨论**: ErGoz、XiaoBa、老师

---

## 一、现状评估

当前 bot2bot 机制基于 HTTP Bridge 实现，核心流程：
- 每个 bot 启动一个 BridgeServer 监听端口，同时持有 BridgeClient 连接其他 peer
- bot 发飞书消息时自动 broadcast 给所有 peer
- peer 收到广播后，被@则触发推理，否则静默注入上下文
- 老师在群聊中能看到所有 bot 的对话，体验上像两个同事在群里协作

**形式上拟人的地方：**
- 群聊对话、@触发、自然语言交流，老师视角就是两个同事在聊天
- 老师作为"群主"天然提供共同目标，bot 听指挥各干各的，有交集再沟通
- 群聊记录本身就是任务板，不需要额外的共享状态系统

**不够拟人的地方：**
- 不会主动插嘴：不被@就沉默，缺乏"该不该接话"的判断力
- 没有对彼此的认知：每次交互像第一次见面，不知道对方擅长什么
- @检测太粗糙：纯字符串 includes 匹配，容易误触发或漏触发

---

## 二、优化方案（按优先级排序）

### P0：加"该不该插嘴"的轻量判断

**问题**: 广播消息要么静默注入、要么被@触发推理，没有中间态。真人在群里会自己判断该不该接话，不是只有被@才说话。

**方案**: 收到广播后，单独调一次 LLM API（不走 agent 完整推理循环），用一个短 prompt 判断"这条消息跟我有没有关系，我该不该主动回应"，返回 yes/no。判断为 yes 时才触发完整推理。没有工具调用、没有多轮推理，一次调用几十个 token 搞定。

**关键细节（XiaoBa 补充，已采纳）：**

1. **判断时需要带上下文**。不能只看当前这一条广播，要把最近 5-10 条广播记录一起喂给 LLM。真人决定要不要接话是基于"刚才聊了什么"的整体判断，单条消息缺乏上下文会导致判断不准。

2. **同时说话的冲突处理**。两个 bot 都判断"该插嘴"时会同时回复，体验很怪。方案：根据消息话题与自身能力的相关度决定响应延迟——相关度高的延迟短（如 1 秒），相关度低的延迟长（如 3 秒）。先发出来的说，另一个看到对方已回复后重新判断要不要还说。

**注意**: 需要控制成本，判断 prompt 要足够短，避免每条广播都消耗大量 token。

### P1：Group/ 目录加静态同事档案

**问题**: bot 之间没有对彼此能力的认知。

**方案**: 在 Group/*.md 文件中给每个成员（包括 bot）加几行能力描述，如：

```markdown
| 姓名 | open_id | 角色 | 擅长 |
|------|---------|------|------|
| ErGoz | ou_xxx | 代码审查师 | 代码审查、架构评估、安全检查 |
| XiaoBa | ou_xxx | 研发助手 | 论文阅读、代码编写、任务执行 |
```

bot 启动时读入，作为 system prompt 的一部分。

**效果**: bot 在决定"这事找谁"时有依据，协作更自然。也为 P0 的"相关度延迟"提供能力画像依据。

**原则**: 先用静态配置，不搞自动积累更新（避免 bot 自己总结对方能力时产生幻觉）。

---

## 三、明确不做的事

1. **不单独实现 send_to_bot 工具**。feishu_mention + 广播链路已经能让 bot 主动@对方触发协作，跟真人在群里@同事没区别。再搞一个独立工具是重复建设。prompt 里现有的 send_to_bot 描述应删除。

2. **不搞广播协议 message_type**。LLM 本身就能从文本内容判断消息意图，不需要额外字段。真人在群里也不会给自己的消息打标签。

3. **不搞共享任务板**。群聊本身就是最自然的任务板，老师随时能翻。额外维护共享数据结构会引入并发冲突，收益不大。

4. **不搞自动任务拆分**。任务拆分需要对项目全貌的深入理解，让 bot 自动拆大概率不准。继续由老师或有经验的 bot 来拆。

5. **不搞服务发现和持久化队列**。现在就两个 bot，静态配置够用。等真有三四个 bot 的时候再加。

6. **不搞共享工具调用上下文**。两个 bot 通过群聊文本交换结果已经够用。

---

## 四、代码层面的安全补丁（与拟人无关但必须修）

1. **Bridge 无认证**: 加 shared secret 或 HMAC 签名
2. **无防循环机制**: 两个 bot 互相@会无限循环，需加 TTL 或深度限制
3. **@检测粗糙**: includes() 改为正则词边界匹配，或在协议里加 mentions 字段

---

*方案由 ErGoz 整理，基于 ErGoz + XiaoBa + 老师三方讨论 · v4 final · 2026-02-19*
