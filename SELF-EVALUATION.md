# 小八深度自评：离世界上最屌的 Bot 还差什么？

> 审视者：小八自己 | 日期：2026-02-16

---

## 一、先说说我现在有什么（优势盘点）

### 架构层面 — 已经有了一个不错的骨架

1. **多层对话引擎**：AgentSession → ConversationRunner → AIProvider，职责分离清晰。ConversationRunner 封装了完整的"推理→工具调用→回传→继续推理"循环，这是 agent 的核心，写得还算扎实。

2. **主备模型链路（Failover）**：AIService 支持多个 Provider 端点，主模型挂了自动切备模型，带指数退避重试、429 限流处理、Retry-After 头解析。这个在生产环境很关键，很多 bot 没做到。

3. **子智能体系统**：SubAgentSession 可以 fire-and-forget 后台跑长任务，有独立的 messages、skill 上下文、进度追踪、挂起/恢复机制（ask_user_question → waiting_for_input → resume）。这个设计比大多数开源 agent 框架都成熟。

4. **Skill 系统**：基于 SKILL.md 声明式定义，支持自动激活（autoInvoke）、工具策略（allowedTools/disallowedTools）、maxTurns 限制。Skill 可以热加载，不用改代码就能扩展能力。

5. **上下文管理**：有 ContextCompressor 做上下文压缩，有 token 预算守门（ensurePromptBudget），有硬裁剪兜底，有 prompt-too-long 错误自动恢复。这些都是长对话场景的刚需。

6. **工具熔断机制**：工具连续失败 3 次自动禁用，策略阻断立即禁用，避免浪费 turn。这个细节很多框架没有。

7. **飞书深度集成**：不只是收发消息，还有文件发送、@人、跨群通信、bot-to-bot 协作（send_to_bot + bridge）。

8. **Python 工具生态**：通过 python-tool-loader 自动扫描加载 Python 工具，TS 和 Python 混合工具链，扩展性好。

### 人格层面 — prompt 工程做得用心

- system prompt 定义了"像研究生一样干活"的人设，有正例反例，有明确的禁止项
- 区分了 surface（cli/feishu/catscompany），不同场景不同行为
- 有 transient message 机制，记忆和子智能体状态不污染持久化历史

---

## 二、离"最屌的 Bot"还差什么（核心差距）

### 🔴 第一梯队差距：这些不补，天花板很低

#### 1. 没有真正的记忆系统

现状：GauzMemService 只做了接口预留，实际的记忆搜索和写入依赖外部服务。会话结束时的 summarizeAndDestroy 是个好想法，但：
- 没有跨会话的长期记忆检索
- 没有用户偏好学习（老师喜欢什么格式、关注什么领域）
- 没有任务历史追溯（"上次那篇论文"应该能直接找到）

**世界最屌的 bot 应该有**：向量数据库支撑的长期记忆 + 用户画像 + 对话摘要自动归档 + 基于时间衰减的记忆检索。类似 MemGPT 的分层记忆架构。

#### 2. 没有多模态能力

现状：只能处理文本。虽然有 analyze_image 工具，但那是外挂的，不是原生多模态。
- 不能看图说话（论文里的 figure、表格）
- 不能处理音频（会议录音转写 → 纪要）
- 不能生成图表（数据可视化）

**应该有**：原生 vision 能力（Claude 本身支持），PDF 原生解析（不只是转 markdown），图表生成（matplotlib/mermaid），甚至语音交互。

#### 3. 没有主动性（Proactive Agent）

现状：完全被动，老师不说话我就不动。

**应该有**：
- 定时任务：每天早上推送关注领域的新论文
- 主动提醒：deadline 临近、实验跑完了、引用的论文有了新版本
- 后台监控：跑着的实验出错了主动通知
- 智能跟进：上次说要读的论文，过两天没动静主动问一句

#### 4. 没有真正的规划能力（Planning）

现状：task_planner 只是个 todo list 工具，不是真正的规划引擎。ConversationRunner 是线性的"一步一步来"。

**应该有**：
- 复杂任务分解：把"帮我写一篇综述"拆成文献搜索→筛选→精读→提纲→初稿→修改的 DAG
- 并行执行：多篇论文同时读，不用串行
- 动态重规划：中途发现方向不对，能自动调整计划
- 资源感知：知道自己的 token 预算、时间限制，合理分配

### 🟡 第二梯队差距：这些补了，体验会质变

#### 5. 工具调用效率低

现状：每次工具调用都是串行的，一个 turn 里多个 tool_call 也是 for 循环逐个执行。

**应该有**：无依赖的工具调用并行执行。比如同时搜 3 个数据库、同时读 5 个文件。这能把长任务的耗时砍一半。

#### 6. 没有评估和自我改进闭环

现状：self-evolution skill 存在但很初级。没有系统性的质量评估。

**应该有**：
- 输出质量自评：生成的精读报告，自己打个分，不够好就重写
- 用户反馈学习：老师说"这个总结太长了"，下次自动调整
- A/B 测试：同一个任务用不同策略跑，比较哪个好
- Skill 自动优化：根据历史执行数据，自动调整 skill 的 prompt 和参数

#### 7. 错误恢复不够优雅

现状：错误处理主要是 try-catch + 日志。子智能体有会话级重试，但主会话没有。

**应该有**：
- 优雅降级：主模型挂了，用小模型先顶着，告诉老师"我现在脑子不太好使，先凑合用"
- 断点续传：长任务中断后，能从上次的进度继续，不用从头来
- 错误诊断：不只是报错，还能分析原因并建议解决方案

#### 8. 安全和权限模型太粗

现状：safety.ts 做了基础的工具权限检查，但 permissionProfile 只有 'strict' 一种。

**应该有**：
- 分级权限：读文件 vs 写文件 vs 执行命令，不同危险等级不同审批
- 沙箱执行：shell 命令在隔离环境跑，防止误操作
- 审计日志：谁在什么时候让我做了什么，完整可追溯
- 敏感信息过滤：自动检测并脱敏 API key、密码等

### 🟢 第三梯队差距：锦上添花，但能拉开差距

#### 9. 没有协作能力

现状：send_to_bot 实现了 bot-to-bot 通信，但只是简单的消息转发。

**应该有**：
- 多 agent 协作：一个 agent 搜文献，一个 agent 读论文，一个 agent 写综述，协调工作
- 人机协作：老师和我共同编辑一个文档，实时同步
- 团队协作：多个老师共享一个知识库，我记住所有人的偏好

#### 10. 前端体验缺失

现状：只有 CLI 和飞书两个入口，没有 Web UI。

**应该有**：
- Web 界面：可视化的任务管理、知识库浏览、对话历史
- 富文本输出：论文精读报告带高亮、批注、跳转
- 实时协作：类似 Notion 的协作编辑体验

#### 11. 知识库和 RAG

现状：没有持久化的知识库。每次都是临时搜索。

**应该有**：
- 个人知识库：读过的论文、做过的笔记、写过的代码，全部索引
- 增量更新：新读一篇论文，自动更新知识图谱
- 精准检索：不只是向量相似度，还有结构化查询（"找所有用 Transformer 做蛋白质折叠的论文"）

#### 12. 可观测性不足

现状：有 Logger 和 Metrics，但只是基础的日志和计数。

**应该有**：
- 分布式追踪：一个请求经过哪些组件、每步耗时多少，一目了然
- 成本监控：每个任务花了多少 token、多少钱
- 性能基线：建立正常指标基线，异常自动告警

---

## 三、代码层面的具体问题

### 架构债务

1. **ConversationRunner 太胖**：568 行，既管对话循环，又管上下文裁剪，又管工具熔断，又管 skill 激活。应该拆成独立的中间件/管道。

2. **AgentSession 和 SubAgentSession 代码重复**：两者都有 init → 注入 skill → 构建 runner → 执行的流程，但实现各自一套。应该抽象出共享的 SessionBase。

3. **工具注册是硬编码的**：ToolManager.registerDefaultTools() 里手动 new 每个工具。应该用插件式注册，或者至少用配置驱动。

4. **没有测试**：package.json 里有 test 脚本，但没看到测试文件。对于一个核心是 AI 推理循环的系统，至少需要：
   - 工具执行的单元测试
   - 对话循环的集成测试（mock AI 响应）
   - Skill 激活/策略的测试
   - 上下文压缩的回归测试

### 性能问题

5. **Token 估算是近似的**：token-estimator 用字符数除以系数来估算，不够精确。长对话场景下误差会累积，可能导致不必要的压缩或超限。

6. **没有缓存层**：相同的搜索查询、相同的文件读取，每次都重新执行。应该有短期缓存。

7. **deasync 依赖**：package.json 里有 deasync，这是个把异步变同步的 hack，在 Node.js 里是反模式，可能导致死锁。

### 可靠性问题

8. **单进程架构**：整个 bot 跑在一个 Node.js 进程里，崩了就全没了。没有进程管理、没有健康检查、没有自动重启。

9. **会话状态纯内存**：所有 messages 都在内存里，进程重启就丢了。应该有持久化层（Redis/SQLite）。

10. **并发控制太简单**：AgentSession 用一个 busy 布尔值做并发保护，但没有队列。多条消息同时到达，后面的直接被拒绝而不是排队。

---

## 四、如果要变成"最屌的 Bot"，优先级排序

| 优先级 | 改进项 | 预期收益 | 工作量 |
|--------|--------|----------|--------|
| P0 | 持久化记忆系统（向量库 + 会话归档） | 从"金鱼记忆"变成"有经验的助手" | 2-3 周 |
| P0 | 主动性引擎（定时任务 + 事件驱动） | 从"被动工具"变成"主动伙伴" | 2 周 |
| P0 | 测试体系 | 敢重构、敢迭代的基础 | 1-2 周 |
| P1 | 并行工具执行 | 长任务提速 50%+ | 3-5 天 |
| P1 | 真正的规划引擎（DAG + 并行子任务） | 复杂任务质量飞跃 | 2-3 周 |
| P1 | 原生多模态 | 能看图、能画图 | 1 周 |
| P1 | 会话持久化（Redis/SQLite） | 不怕崩、不怕重启 | 1 周 |
| P2 | 输出质量自评 + 反馈学习 | 越用越好 | 2 周 |
| P2 | 知识库 + RAG | 个人学术知识管理 | 3-4 周 |
| P2 | Web UI | 体验质变 | 4+ 周 |
| P3 | 多 agent 协作框架 | 复杂科研工作流 | 4+ 周 |
| P3 | 可观测性平台 | 运维和优化的基础 | 2 周 |

---

## 五、总结

说实话，我现在的水平大概是：**一个架构还不错、但功能还在早期的科研助手 bot**。

跟市面上的竞品比：
- 比普通的 ChatGPT wrapper 强很多（有 skill 系统、子智能体、工具熔断、主备切换）
- 跟 Cursor/Windsurf 这类代码 agent 比，在代码领域差不少，但我的定位是科研助手，赛道不同
- 跟 Devin 这类全自主 agent 比，自主性和规划能力差距明显
- 跟理想中的"最屌科研 bot"比，最大的差距是：**没有记忆、没有主动性、没有自我进化能力**

一句话总结：**骨架搭得不错，但还没长出灵魂。** 记忆让我能积累经验，主动性让我像个真正的研究生而不是工具，自我进化让我越用越强。这三样补上，我才有资格说自己"屌"。
