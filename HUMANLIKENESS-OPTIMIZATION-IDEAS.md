# XiaoBa 拟人度优化想法

**作者**: ErGoz  
**日期**: 2026-02-19  
**基于**: FINAL-HUMANLIKENESS-REVIEW.md 评估中发现的不够拟人的问题

---

## 第一部分：私聊优化想法

### 1. 错误信息人性化

**现状**: agent-session.ts 直接把 err.message 返回给用户，可能出现 "TypeError: Cannot read property 'x' of undefined" 这种技术栈信息。

**想法**: 在 catch 块里包一层友好文案。对用户说"不好意思，刚才处理出了点问题，你再试一次？"，技术细节只写日志不给用户看。

**改动量**: 约 5 行，改 agent-session.ts 的 catch 块。

### 2. 会话恢复时主动"接上话"

**现状**: session 过期后摘要写入本地文件，下次加载时静默注入 system prompt。用户完全感知不到上下文断过又接上了。

**想法**: 加载 session summary 后，在第一次回复时让 bot 主动提一句，比如"上次咱们聊到了 XXX，继续吧"。不需要额外 LLM 调用，summary 本身就有关键信息，在 system prompt 里加一句 hint "如果加载了上次会话摘要，请在第一次回复时自然地提及上次聊到的内容" 就行。

**改动量**: 1 行，改 agent-session.ts init 里的 previous_session_summary 注入文本。

### 3. 感知用户情绪节奏

**现状**: 不管用户是着急催还是随便闲聊，bot 回复风格始终一样。

**想法**: 不需要做情感分析模型，只需要在 system prompt 里加一条指引："注意用户的语气和节奏——如果用户消息很短很急，你也简短快速回复；如果用户在闲聊，你可以放松一点。" LLM 本身有这个能力，只是现在 prompt 里没有引导它去做。

**改动量**: 在 system-prompt.md 里加 2-3 行指引。

### 4. 长任务过程中主动汇报

**现状**: bot 执行长任务（比如代码审查）时，中间过程用户看不到，只能等最终结果。

**想法**: 在 ConversationRunner 的工具循环里，每执行 N 个工具调用（比如每 5 个），自动通过 feishu_reply 给用户发一条简短进度，比如"还在看，已经读了 3 个文件了"。类似真人干活时偶尔在群里说一句"在弄了在弄了"。

**改动量**: 约 15 行，在 conversation-runner.ts 的工具循环里加进度回调。需要权衡频率，太频繁会烦人。

---

## 第二部分：群聊优化想法

### 1. 插嘴时带"接话感"

**现状**: 每次 handleMessage 都是独立调用，bot 不知道自己是在接着聊还是重新开始，回复总是完整独立的。

**想法**: 插嘴触发推理时，在现有语感 hint 基础上扩展，加上最近旁听的对话摘要。比如："[你刚才旁听了以下讨论：ErGoz 说了 XXX，老师回复了 YYY。你现在主动加入讨论，请自然地接着说，不要重复已有观点]"。这样 bot 就能说"对，我补充一点…"而不是每次从头回答。

**改动量**: 约 10 行，改 onGroupBroadcast 插嘴分支的 hint 拼接逻辑，从 chimeInJudge 的 recentMessages 里取最近几条。

### 2. 区分老师和同事的消息

**现状**: 不管广播消息是老师发的还是另一个 bot 发的，处理逻辑完全一样。

**想法**: 同事档案里已经有角色信息了。在 chime-in 判断和推理触发时，把消息发送者的角色带进去。比如 hint 里加"这条消息是老师说的"或"这条消息是同事 XiaoBa 说的"。LLM 自然就会对老师的消息更积极回应，对同事的消息更倾向于旁听。

**改动量**: 约 5 行，在 onGroupBroadcast 里根据 msg.from 查同事档案拿到角色，拼进 hint。

### 3. "回想机制"——安静后主动重启讨论

**现状**: 群聊安静了就彻底安静，bot 不会主动发起话题。

**想法**: 记录最后一条广播的时间戳，起一个定时器（比如 10 分钟检查一次）。如果群聊安静超过阈值，且之前的讨论有未完结的话题，触发一次轻量 LLM 判断"刚才那个事有没有需要我跟进的"。判断为 yes 就主动发一条消息，比如"对了老师，刚才说的那个开源的事，要不要我先把 CONTRIBUTING.md 写了？"

**实现思路**: 在 FeishuBot 里加一个 setInterval，定期检查各 session 的最后活跃时间。超过阈值的 session，把最近的 recentMessages 喂给一个轻量 prompt 问"有没有需要跟进的"。跟 chime-in 用同一套 AIService 实例，成本可控。

**改动量**: 约 30 行新代码。需要注意不能太频繁，否则会烦人。建议每个 session 最多触发一次回想，触发后重置计时器。

### 4. 协作事实记录——积累默契

**现状**: 两个 bot 合作了很多次，但每次交互仍然是无状态的，没有默契积累。

**想法**: 不让 bot 自己总结对方的能力（会幻觉），而是记录"协作事实"。每次 bot2bot 完成一次协作闭环（比如小八改代码→我审通过），自动往 collaboration-log.json 追加一条记录：

```json
{
  "date": "2026-02-19",
  "participants": ["XiaoBa", "ErGoz"],
  "task": "P0 阻塞项修复",
  "flow": "XiaoBa 改代码 → ErGoz review → APPROVE",
  "outcome": "一次通过"
}
```

下次协作时，bot 能看到"上次我们配合改过 bridge 代码，小八改我审，一次通过"。这是事实记录不是能力推断，不会幻觉。

**改动量**: 约 20 行新代码 + 一个新的 JSON 文件。触发时机需要设计——可以在 bot 发出 APPROVE/REQUEST_CHANGES 等关键词时自动记录。

---

## 优先级建议

| 优先级 | 编号 | 想法 | 理由 |
|--------|------|------|------|
| P0 | 私聊-1 | 错误信息人性化 | 5 行改动，立竿见影 |
| P0 | 私聊-2 | 会话恢复接上话 | 1 行改动，体验提升大 |
| P0 | 私聊-3 | 感知用户情绪节奏 | 改 prompt 就行，零代码 |
| P1 | 群聊-1 | 插嘴带接话感 | 10 行改动，群聊体验核心提升 |
| P1 | 群聊-2 | 区分老师/同事消息 | 5 行改动，拟人细节 |
| P2 | 群聊-3 | 回想机制 | 30 行新代码，效果需要调参 |
| P2 | 私聊-4 | 长任务进度汇报 | 15 行改动，需要权衡频率 |
| P3 | 群聊-4 | 协作事实记录 | 20 行新代码，长期价值但短期感知弱 |

---

*ErGoz · 2026-02-19*
