# XiaoBa 开源就绪评估报告

**审查人**: ErGoz  
**日期**: 2026-02-19  
**评估范围**: 全量源码 (`src/`, `skills/`, `tools/`, 配置文件, 文档)  
**结论**: ⚠️ **REQUEST_CHANGES — 有 2 个阻塞项必须修复后才能开源**

---

## 一、阻塞项（必须修复）

### 🔴 B1: 源码中硬编码了内部服务器 IP 和个人信息

**影响**: 泄露内部基础设施地址 + 个人身份信息  
**严重程度**: 高（开源后全球可见）

以下 5 个文件中硬编码了内部 IP `43.139.19.144` 和个人用户名 `guowei` 作为 fallback 默认值：

| 文件 | 行号 | 问题 |
|------|------|------|
| `src/utils/config.ts` | 60, 62 | `baseUrl` 默认 `http://43.139.19.144:1235`，`userId` 默认 `guowei` |
| `src/feishu/index.ts` | 122, 124 | 同上 |
| `src/catscompany/index.ts` | 86, 88 | 同上 |
| `src/commands/chat.ts` | 39, 41 | 同上 |
| `src/commands/config.ts` | 57, 71 | 同上 |

**修复方案**: 将 fallback 改为空字符串或占位符（如 `http://localhost:1235`、`default-user`），让用户必须自行配置。

### 🔴 B2: package.json 引用了本地路径依赖

**影响**: 任何人 clone 后 `npm install` 必定失败  
**严重程度**: 高（项目无法构建）

```json
"@catscompany/bot-sdk": "file:../openchat/bot-sdk/typescript"
```

`package.json:47` 引用了一个相对路径的本地包 `../openchat/bot-sdk/typescript`，这个路径在其他人的机器上不存在。

**修复方案**:
- 方案 A: 将 `@catscompany/bot-sdk` 发布到 npm，改为版本号引用
- 方案 B: 将其作为 git submodule 或 bundled dependency
- 方案 C: 如果 CatsCompany 集成不开源，将其设为 `optionalDependencies` 并在代码中做 graceful fallback

---

## 二、建议修复项（强烈建议）

### 🟡 S1: package.json 中 author 字段未填写

```json
"author": "Your Name <your-email@example.com>"
```

开源项目应填写真实的组织/作者信息，如 `"author": "CatCompany"` 或 `"author": "buildsense-ai"`。

### 🟡 S2: .env.example 中 GAUZ_MEM 默认值暴露内部信息

`.env.example` 本身没有硬编码 IP（是 placeholder），但源码中的 fallback 值会在用户不配置时自动连接内部服务器。这与 B1 是同一个问题的不同表现。

### 🟡 S3: Anthropic Provider 中刻意清除 SDK 指纹头

`src/providers/anthropic-provider.ts:22-28`:
```typescript
defaultHeaders: {
  'User-Agent': 'XiaoBa/0.1.0',
  'x-stainless-lang': undefined as any,
  'x-stainless-package-version': undefined as any,
  // ...
}
```

这段代码刻意清除了 Anthropic SDK 的遥测头。开源后这会引起社区质疑（为什么要隐藏 SDK 指纹？）。建议保留 SDK 默认行为，或在注释中说明原因。

### 🟡 S4: 缺少 CONTRIBUTING.md

README 中有简单的贡献指引，但缺少独立的 `CONTRIBUTING.md`，应包含：
- 开发环境搭建步骤
- 代码规范（lint/format 配置）
- PR 流程和审查标准
- Skill 开发指南

### 🟡 S5: 缺少自动化测试和 CI

- `tests/` 目录在 `.gitignore` 中被排除
- 没有 CI 配置（GitHub Actions / etc.）
- `npm test` 指向 `tsx --test tests/**/*.test.ts`，但测试文件不会被提交

开源项目没有测试会严重影响社区信任度和贡献意愿。

---

## 三、代码质量评估（正面）

### ✅ 架构设计清晰

- **分层合理**: `providers/` → `core/` → `tools/` → `commands/` 职责清晰
- **抽象到位**: `AIProvider` 接口统一了 Anthropic/OpenAI，`ToolExecutor` 接口解耦了工具执行
- **Skill 引擎**: Markdown 定义 + 自动发现 + 工具策略，设计优雅且易扩展

### ✅ 安全机制完善

- **工具白名单**: `GAUZ_TOOL_ALLOW` 默认阻断高危工具（shell、write、edit）
- **Bash 命令过滤**: 拦截 `rm -rf /`、fork bomb、`shutdown` 等危险命令
- **文件系统沙箱**: 默认禁止读写工作目录外的文件，禁止修改 `.env`
- **Skill 工具策略**: 支持 `allowedTools` / `disallowedTools` 细粒度控制
- **工具熔断**: 连续失败 3 次自动禁用，策略阻断立即禁用

### ✅ LLM Failover Chain 实现成熟

- 主备模型链路支持多级切换
- 区分可重试错误（429/502/503）和需切换错误（401/403）
- 流式输出中断后默认不切换（避免重复文本），可配置强制切换
- 指数退避 + Retry-After 头解析

### ✅ 上下文管理健壮

- Token 估算 + 自动压缩 + 紧急裁剪三级保护
- 临时上下文（记忆、子智能体状态）不持久化到历史
- 会话退出时自动生成摘要，下次加载恢复上下文

### ✅ 并发控制到位

- 主会话 `busy` 锁 + 消息队列排空机制
- 子智能体并发限制（每会话最多 3 个）
- 子智能体反馈注入等待主会话空闲，避免竞态

---

## 四、代码质量评估（待改进）

### 🟠 类型安全有缺口

多处使用 `any` 类型，如：
- `bash-tool.ts:36` — `args: any`
- `tool-manager.ts:172` — `conversationHistory?: any[]`
- `openai-provider.ts:29` — `buildRequestBody` 返回 `any`

建议逐步收紧为具体类型，至少在公开 API 层面。

### 🟠 错误处理可以更精细

`agent-session.ts:302-308` 的 catch 块直接将 `err.message` 返回给用户，可能泄露内部实现细节（如 API 端点、模型名称）。开源后应考虑对用户可见的错误信息做脱敏。

### 🟠 日志中可能包含敏感信息

`ai-service.ts:86` 日志输出了完整的模型链路信息（包含 provider/model），`conversation-runner.ts:211` 输出了工具参数。生产环境应有日志级别控制（已有 Logger 分级，但默认级别需确认）。

---

## 五、开源清单检查

| 检查项 | 状态 | 备注 |
|--------|------|------|
| LICENSE 文件 | ✅ | MIT，合规 |
| README.md | ✅ | 质量高，结构完整 |
| .env.example | ✅ | 占位符正确，无真实密钥 |
| .gitignore | ✅ | 覆盖全面，.env/node_modules/dist 等均已排除 |
| .env 未提交 | ✅ | 不在 git 跟踪中 |
| 源码无硬编码密钥 | ✅ | 未发现 API key 硬编码 |
| 源码无内部 IP/个人信息 | ❌ | **B1** |
| 依赖可安装 | ❌ | **B2** |
| 自动化测试 | ❌ | **S5** |
| CI/CD 配置 | ❌ | 无 |
| CONTRIBUTING.md | ❌ | **S4** |
| CHANGELOG.md | ❌ | 建议添加 |
| author 字段 | ❌ | **S1** |

---

## 六、总结

XiaoBa 的代码质量在 AI Agent 框架中属于上乘水平。架构分层清晰、安全机制完善、LLM failover 和上下文管理都经过了认真设计。Skill 引擎的 Markdown 定义 + 自动发现机制是一个亮点，降低了扩展门槛。

**但有 2 个阻塞项必须修复**：
1. 源码中硬编码的内部 IP 和个人用户名（5 个文件）
2. package.json 中的本地路径依赖（clone 后无法构建）

修复这两项后，再补上 CONTRIBUTING.md 和基础测试，就可以开源了。

---

*Report generated by ErGoz · 2026-02-19*
